(()=>{var p=Object.defineProperty;var _=(a,r,n)=>r in a?p(a,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[r]=n;var c=(a,r,n)=>_(a,typeof r!="symbol"?r+"":r,n);var I=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},S={exports:{}},f={exports:{}},v;function g(){return v||(v=1,function(a){(function(r){var n=-1,t={onVisible:function(e){var i=t.isSupported();if(!i||!t.hidden())return e(),i;var s=t.change(function(o,u){t.hidden()||(t.unbind(s),e())});return s},change:function(e){if(!t.isSupported())return!1;n+=1;var i=n;return t._callbacks[i]=e,t._listen(),i},unbind:function(e){delete t._callbacks[e]},afterPrerendering:function(e){var i=t.isSupported(),s="prerender";if(!i||s!=t.state())return e(),i;var o=t.change(function(u,h){s!=h&&(t.unbind(o),e())});return o},hidden:function(){return!!(t._doc.hidden||t._doc.webkitHidden)},state:function(){return t._doc.visibilityState||t._doc.webkitVisibilityState||"visible"},isSupported:function(){return t._doc.hidden!==void 0||t._doc.webkitHidden!==void 0},_doc:document||{},_callbacks:{},_change:function(e){var i=t.state();for(var s in t._callbacks)t._callbacks[s].call(t._doc,e,i)},_listen:function(){if(!t._init){var e="visibilitychange";t._doc.webkitVisibilityState&&(e="webkit"+e);var i=function(){t._change.apply(t,arguments)};t._doc.addEventListener?t._doc.addEventListener(e,i):t._doc.attachEvent(e,i),t._init=!0}}};a.exports?a.exports=t:r.Visibility=t})(I)}(f)),f.exports}(function(a){(function(r){var n=-1,t=function(e){return e.every=function(i,s,o){e._time(),o||(o=s,s=null),n+=1;var u=n;return e._timers[u]={visible:i,hidden:s,callback:o},e._run(u,!1),e.isSupported()&&e._listen(),u},e.stop=function(i){return e._timers[i]?(e._stop(i),delete e._timers[i],!0):!1},e._timers={},e._time=function(){e._timed||(e._timed=!0,e._wasHidden=e.hidden(),e.change(function(){e._stopRun(),e._wasHidden=e.hidden()}))},e._run=function(i,s){var o,u=e._timers[i];if(e.hidden()){if(u.hidden===null)return;o=u.hidden}else o=u.visible;var h=function(){u.last=new Date,u.callback.call(r)};if(s){var b=new Date,m=b-u.last;o>m?u.delay=setTimeout(function(){u.id=setInterval(h,o),h()},o-m):(u.id=setInterval(h,o),h())}else u.id=setInterval(h,o)},e._stop=function(i){var s=e._timers[i];clearInterval(s.id),clearTimeout(s.delay),delete s.id,delete s.delay},e._stopRun=function(i){var s=e.hidden(),o=e._wasHidden;if(s&&!o||!s&&o)for(var u in e._timers)e._stop(u),e._run(u,!s)},e};a.exports?a.exports=t(g()):t(r.Visibility||g())})(window)})(S);var E=S.exports,U=E,l=(a=>(a.GET_SHOW_MANAGER="getShowManager",a.SET_SHOW_MANAGER="setShowManager",a.DELETE_SHOW_MANAGER="deleteShowManager",a.FOCUS_INPUT="focusInput",a.BLUR_INPUT="blurInput",a.RESOURCE_CHANGED="resourceChanged",a))(l||{}),d=(a=>(a.DEFAULT="default",a.CHOICE="choice",a.CHECKBOX="checkbox",a))(d||{});function N(a,r){if(a===null||a.getAttribute("data-user-id")===null||a.getAttribute("data-user-name")===null||a.closest("form")===null||a.getAttribute("data-form-channel")===null||!r.callbacks.onMoonShineWS||!r.callbacks.rushPublish)return null;let n="";return a.getAttribute("data-user-avatar")!==null&&(n=a.getAttribute("data-user-avatar")),new w(parseInt(a.getAttribute("data-user-id")),a.getAttribute("data-user-name"),n,a.closest("form"),a.getAttribute("data-form-channel"),r)}class w{constructor(r,n,t,e,i,s){c(this,"moonShine");c(this,"userId");c(this,"userName");c(this,"avatar");c(this,"form");c(this,"channel");c(this,"stateVisible","visible");c(this,"focusElementName",null);this.userId=r,this.userName=n,this.form=e,this.channel=i,this.moonShine=s,this.avatar=t,this.registerVisibility(),this.registerEvents()}getShowManager(){this.stateVisible==="visible"&&(this.moonShine.callbacks.rushPublish(this.channel,{event:l.SET_SHOW_MANAGER,data:{userName:this.userName,userId:this.userId,avatar:this.avatar}}),this.focusElementName!==null&&this.moonShine.callbacks.rushPublish(this.channel,{event:l.FOCUS_INPUT,data:{inputName:this.focusElementName,userId:this.userId,userName:this.userName}}))}registerVisibility(){U.change((r,n)=>{n==="hidden"&&(this.stateVisible=n,this.hideUserInPage()),n==="visible"&&(this.stateVisible=n,this.moonShine.callbacks.rushPublish(this.channel,{event:l.SET_SHOW_MANAGER,data:{userName:this.userName,userId:this.userId,avatar:this.avatar}}))})}registerEvents(){this.registerInputFocus(this.form.querySelectorAll("input")),this.registerInputFocus(this.form.querySelectorAll("textarea")),this.registerInputFocus(this.form.querySelectorAll("select")),this.registerChoiceFocus(),this.registerCheckboxFocus(this.form.querySelectorAll(".form-checkbox")),window.addEventListener("beforeunload",()=>{this.hideUserInPage()})}registerCheckboxFocus(r){for(let n=0;n<r.length;n++)r[n].addEventListener("click",t=>{const e=t.target;if(e===null)return;const i=e.getAttribute("name");this.focusElementName=i,this.moonShine.callbacks.rushPublish(this.channel,{event:l.FOCUS_INPUT,data:{inputName:i,userId:this.userId,userName:this.userName,elementType:d.CHECKBOX}}),setTimeout(()=>{this.moonShine.callbacks.rushPublish(this.channel,{event:l.BLUR_INPUT,data:{inputName:i,userId:this.userId,elementType:d.CHECKBOX}})},2e3)})}registerInputFocus(r){for(let n=0;n<r.length;n++)r[n].addEventListener("focus",t=>{const e=t.target;if(e===null)return;const i=e.getAttribute("type");i==="checkbox"||i==="file"||(this.focusElementName=e.getAttribute("name"),this.moonShine.callbacks.rushPublish(this.channel,{event:l.FOCUS_INPUT,data:{inputName:e.getAttribute("name"),userId:this.userId,userName:this.userName,elementType:d.DEFAULT}}))}),r[n].addEventListener("blur",t=>{const e=t.target;e!==null&&(this.focusElementName=null,this.moonShine.callbacks.rushPublish(this.channel,{event:l.BLUR_INPUT,data:{inputName:e.getAttribute("name"),userId:this.userId,elementType:d.DEFAULT}}))})}registerChoiceFocus(){(async n=>{for(;n.querySelector(".choices")===null;)await new Promise(t=>requestAnimationFrame(t));return document.querySelectorAll(".choices")})(this.form).then(n=>{var t;for(let e=0;e<n.length;e++){const i=n[e],s=(t=i.querySelector("select"))==null?void 0:t.getAttribute("name");s!==void 0&&(i.setAttribute("select-name",s),n[e].addEventListener("focus",()=>{this.focusElementName=s,this.moonShine.callbacks.rushPublish(this.channel,{event:l.FOCUS_INPUT,data:{inputName:s,userId:this.userId,userName:this.userName,elementType:d.CHOICE}})}),n[e].addEventListener("blur",()=>{this.focusElementName=null,this.moonShine.callbacks.rushPublish(this.channel,{event:l.BLUR_INPUT,data:{inputName:s,userId:this.userId,elementType:d.CHOICE}})}))}})}hideUserInPage(){this.moonShine.callbacks.rushPublish(this.channel,{event:l.DELETE_SHOW_MANAGER,data:{userId:this.userId}}),this.focusElementName!==null&&(this.moonShine.callbacks.rushPublish(this.channel,{event:l.BLUR_INPUT,data:{inputName:this.focusElementName,userId:this.userId}}),this.focusElementName=null)}getUserId(){return this.userId}getUserName(){return this.userName}getAvatar(){return this.avatar}getChannel(){return this.channel}getForm(){return this.form}}class A{constructor(r){c(this,"formUsers",{});c(this,"channel");this.channel=r}setShowUser(r,n,t){if(this.formUsers[this.channel]||(this.formUsers[this.channel]={}),this.formUsers[this.channel][r]){this.formUsers[this.channel][r].isOnFrom=!0,this.renderUsers(this.formUsers[this.channel]);return}const e=Math.floor(Math.random()*200),i=Math.floor(Math.random()*200),s=Math.floor(Math.random()*200);this.formUsers[this.channel][r]={id:r,name:n,color:`rgba(${e}, ${i}, ${s}, 0.65)`,avatar:t,isOnFrom:!0},this.renderUsers(this.formUsers[this.channel])}deleteShowUser(r){this.formUsers[this.channel]&&this.formUsers[this.channel][r]&&(this.formUsers[this.channel][r].isOnFrom=!1,this.renderUsers(this.formUsers[this.channel]))}renderUsers(r){const n=document.querySelector(`[data-form-channel=${this.channel}]`);n!==null&&Object.values(r).forEach(t=>{const e=n.querySelector(`[data-user-id="${t.id}"]`);if(!t.isOnFrom&&e!==null){e.style.display="none";return}if(e!==null){e.style.display="inline-flex";return}const i=document.createElement("div");if(i.classList.add("user-on-form"),i.style.setProperty("border-radius","50%","important"),i.title=t.name,i.setAttribute("data-user-id",t.id.toString()),t.avatar){const s=document.createElement("img");s.src=t.avatar,s.alt=t.name,s.style.width="100%",s.style.height="100%",s.style.setProperty("border-radius","50%","important"),i.appendChild(s)}else i.style.backgroundColor=t.color,i.innerText=t.name.substring(0,2).toUpperCase();n.appendChild(i)})}}class k{constructor(r,n){c(this,"focusInputs",{});c(this,"users",{});c(this,"channel");c(this,"nowOnForm");this.channel=r,this.nowOnForm=n}focus(r,n,t,e){var h;const i=this.getInputElement(this.nowOnForm.getForm(),t,e);if(i===null)return;const s=this.nowOnForm.getUserId();if(r===s||(this.focusInputs[this.channel]||(this.focusInputs[this.channel]={}),this.focusInputs[this.channel][t]||(this.focusInputs[this.channel][t]=[]),this.focusInputs[this.channel][t].indexOf(r)!==-1))return;this.users[r]||(this.users[r]={userId:r,userName:n}),this.focusInputs[this.channel][t].push(r),i.classList.add("rush-input-focus");const o=document.createElement("div");o.classList.add("tooltip"),o.setAttribute("tooltip-name",t);const u=this.getUsers();o.innerHTML=`<div class="bottom">${this.editIcon()} ${u.join(",")}</div>`,(h=i.parentNode)==null||h.insertBefore(o,i.nextSibling)}blur(r,n,t){const e=this.getInputElement(this.nowOnForm.getForm(),n,t);if(e===null)return;const i=this.nowOnForm.getUserId();if(r===i||!this.focusInputs[this.channel]||!this.focusInputs[this.channel][n])return;this.focusInputs[this.channel][n]=this.focusInputs[this.channel][n].filter(o=>r!==o),this.users=Object.values(this.users).filter(o=>o.userId!==r);const s=document.querySelector(`[tooltip-name="${n}"]`);if(this.focusInputs[this.channel][n].length===0)e.classList.remove("rush-input-focus"),s==null||s.remove();else{const o=this.getUsers();s!==null&&(s.innerHTML=`<div class="bottom">${this.editIcon()} ${o.join(",")}</div>`)}}getInputElement(r,n,t){var e;switch(t){case d.DEFAULT:return r.querySelector(`[name="${n}"]`);case d.CHOICE:return r.querySelector(`[select-name="${n}"]`);case d.CHECKBOX:const i=r.querySelector(`input[name="${n}"]`);if(i===null)return null;const s=i.closest(".form-switcher");if(s!==null)return s;const o=(e=i.closest("div"))==null?void 0:e.querySelector(".form-checkbox");return o===void 0?null:o;default:return null}}getUsers(){return Object.values(this.users).map(r=>r.userName)}editIcon(){return'<div class="text-current w-3 h-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"></path></svg></div>'}}document.addEventListener("moonshine:rush",()=>{const a=window.MoonShine;if(!a.callbacks.onMoonShineWS)return;const r=N(document.getElementById("nowOnFormData"),a);if(r===null)return;const n=r.getChannel(),t=new A(n),e=new k(n,r);C(a,t,r),a.callbacks.onMoonShineWS(n,i=>{let s;switch(i.event){case l.GET_SHOW_MANAGER:r.getShowManager();break;case l.SET_SHOW_MANAGER:s=i.data,t.setShowUser(s.userId,s.userName,s.avatar);break;case l.DELETE_SHOW_MANAGER:s=i.data,t.deleteShowUser(s.userId);break;case l.FOCUS_INPUT:s=i.data,e.focus(s.userId,s.userName,s.inputName,s.elementType);break;case l.BLUR_INPUT:s=i.data,e.blur(s.userId,s.inputName,s.elementType);break;case l.RESOURCE_CHANGED:if(s=i.data,r.getUserId()===s.userId)return;const o=document.getElementById("modal-"+n);if(o===null)return;const u=document.getElementById("text-"+n);u&&(u.innerHTML=s.modalContent);const h=o.closest("div");h==null||h.dispatchEvent(new CustomEvent("modal-toggled-"+n,{bubbles:!0}));break}})});function C(a,r,n){const t=n.getChannel();document.addEventListener("rush-subscribe:"+t,function(){a.callbacks.rushPublish(t,{event:l.GET_SHOW_MANAGER}),n.getShowManager(),r.setShowUser(n.getUserId(),n.getUserName(),n.getAvatar())})}
})()